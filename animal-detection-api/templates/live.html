<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📡 Live Stream - Animal Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'farm-green': '#22c55e',
                        'farm-brown': '#a3a3a3',
                        'alert-red': '#ef4444',
                        'alert-orange': '#f97316',
                        'alert-yellow': '#eab308'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-red-50 to-red-100 min-h-screen">
    
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg border-b-4 border-red-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-gray-900">📡 Live Stream</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-700 hover:text-red-500 px-3 py-2 rounded-md text-sm font-medium transition">Home</a>
                    <a href="/upload" class="text-gray-700 hover:text-red-500 px-3 py-2 rounded-md text-sm font-medium transition">Upload</a>
                    <a href="/live" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Live Stream</a>
                    <a href="/results" class="text-gray-700 hover:text-red-500 px-3 py-2 rounded-md text-sm font-medium transition">Results</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">📡 Live CCTV Monitoring</h1>
            <p class="text-lg text-gray-600">Connect to CCTV cameras for real-time animal detection and instant alerts</p>
        </div>

        <!-- Stream Control Panel -->
        <div class="bg-white rounded-lg shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">🎛️ Stream Control</h2>
            
            <!-- RTSP URL Input -->
            <div class="max-w-2xl mx-auto mb-6">
                <label for="rtspUrl" class="block text-sm font-medium text-gray-700 mb-2">RTSP/HTTP Stream URL</label>
                <div class="flex gap-2">
                    <input type="url" id="rtspUrl" 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" 
                           placeholder="rtsp://username:password@camera-ip:port/stream or http://camera-ip/video"
                           value="">
                    <button id="connectBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="connectBtnText">🔴 Start Stream</span>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-2">Enter your CCTV camera's RTSP URL or HTTP video stream URL</p>
            </div>

            <!-- Quick Connect Options -->
            <div class="max-w-2xl mx-auto mb-6">
                <h3 class="text-sm font-medium text-gray-700 mb-3">📱 Quick Connect (Test Sources)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button class="test-source px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm" 
                            data-url="0">📷 Webcam (Camera 0)</button>
                    <button class="test-source px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm" 
                            data-url="1">📷 Webcam (Camera 1)</button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="text-center">
                <div class="inline-flex items-center px-4 py-2 rounded-lg bg-gray-100 text-gray-600">
                    <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                    <span>Disconnected</span>
                </div>
            </div>
        </div>

        <!-- Live Stream Display -->
        <div class="bg-white rounded-lg shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">📺 Live Feed</h2>
            
            <!-- Video Stream Container -->
            <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                <img id="videoStream" 
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='450'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-size='24'%3ENo Stream Active%3C/text%3E%3C/svg%3E"
                     alt="Video Stream" 
                     class="w-full h-full object-cover">
                
                <!-- Stream Overlay -->
                <div id="streamOverlay" class="absolute top-4 left-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-lg text-sm">
                    🔴 OFFLINE
                </div>
                
                <!-- Detection Counter -->
                <div id="detectionCounter" class="absolute top-4 right-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-lg text-sm hidden">
                    🐾 0 animals detected
                </div>
                
                <!-- Stream Controls Overlay -->
                <div id="streamControls" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 hidden">
                    <div class="flex gap-2">
                        <button id="pauseBtn" class="bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg hover:bg-opacity-90 transition">
                            ⏸️ Pause
                        </button>
                        <button id="screenshotBtn" class="bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg hover:bg-opacity-90 transition">
                            📸 Screenshot
                        </button>
                        <button id="fullscreenBtn" class="bg-black bg-opacity-70 text-white px-3 py-2 rounded-lg hover:bg-opacity-90 transition">
                            🖥️ Fullscreen
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Detection Results -->
        <div id="liveResults" class="bg-white rounded-lg shadow-xl p-8 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">🔍 Live Detection Results</h2>
            
            <!-- Current Detections -->
            <div id="currentDetections" class="mb-6">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Detection History -->
            <div id="detectionHistory" class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">📜 Recent Detections</h3>
                <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Stream Statistics -->
        <div id="streamStats" class="bg-white rounded-lg shadow-xl p-8 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">📊 Stream Statistics</h2>
            
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white text-center">
                    <div class="text-2xl font-bold" id="frameCount">0</div>
                    <div class="text-sm opacity-90">Frames</div>
                </div>
                <div class="bg-gradient-to-r from-farm-green to-green-600 rounded-lg p-4 text-white text-center">
                    <div class="text-2xl font-bold" id="fpsCount">0</div>
                    <div class="text-sm opacity-90">FPS</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white text-center">
                    <div class="text-2xl font-bold" id="totalDetections">0</div>
                    <div class="text-sm opacity-90">Total Detections</div>
                </div>
                <div class="bg-gradient-to-r from-alert-orange to-orange-600 rounded-lg p-4 text-white text-center">
                    <div class="text-2xl font-bold" id="streamUptime">00:00</div>
                    <div class="text-sm opacity-90">Uptime</div>
                </div>
            </div>
        </div>

        <!-- Setup Guide -->
        <div class="bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">🛠️ CCTV Setup Guide</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">📡 RTSP Stream URLs</h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <strong>Generic Format:</strong><br>
                            <code class="text-blue-600">rtsp://username:password@ip:port/path</code>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <strong>Hikvision:</strong><br>
                            <code class="text-blue-600">rtsp://admin:password@192.168.1.100:554/Streaming/Channels/101</code>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <strong>Dahua:</strong><br>
                            <code class="text-blue-600">rtsp://admin:password@192.168.1.100:554/cam/realmonitor?channel=1&subtype=0</code>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <strong>Axis:</strong><br>
                            <code class="text-blue-600">rtsp://root:password@192.168.1.100/axis-media/media.amp</code>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">💡 Connection Tips</h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Ensure camera is on the same network</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Check firewall settings</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Use correct username/password</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Verify RTSP is enabled on camera</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Test with VLC media player first</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Use stable network connection</li>
                    </ul>
                    
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 mt-6">⚡ Performance Tips</h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Lower camera resolution for better performance</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Reduce frame rate if needed</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Use wired connection when possible</li>
                        <li class="flex items-start"><span class="text-farm-green mr-2 mt-1">•</span>Close other bandwidth-heavy applications</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let isStreaming = false;
        let streamStartTime = null;
        let detectionHistory = [];
        let statsInterval = null;
        let uptimeInterval = null;

        // DOM Elements
        const rtspUrl = document.getElementById('rtspUrl');
        const connectBtn = document.getElementById('connectBtn');
        const connectBtnText = document.getElementById('connectBtnText');
        const connectionStatus = document.getElementById('connectionStatus');
        const videoStream = document.getElementById('videoStream');
        const streamOverlay = document.getElementById('streamOverlay');
        const detectionCounter = document.getElementById('detectionCounter');
        const streamControls = document.getElementById('streamControls');
        const liveResults = document.getElementById('liveResults');
        const streamStats = document.getElementById('streamStats');

        // Event Listeners
        connectBtn.addEventListener('click', toggleStream);
        document.getElementById('screenshotBtn')?.addEventListener('click', takeScreenshot);
        document.getElementById('fullscreenBtn')?.addEventListener('click', toggleFullscreen);

        // Test source buttons
        document.querySelectorAll('.test-source').forEach(btn => {
            btn.addEventListener('click', (e) => {
                rtspUrl.value = e.target.dataset.url;
            });
        });

        async function toggleStream() {
            if (isStreaming) {
                stopStream();
            } else {
                startStream();
            }
        }

        async function startStream() {
            const url = rtspUrl.value.trim();
            if (!url) {
                alert('Please enter a valid RTSP/HTTP URL or select a test source');
                return;
            }

            connectBtn.disabled = true;
            connectBtnText.textContent = '🔄 Connecting...';

            try {
                const response = await fetch('/api/start_live_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ rtsp_url: url })
                });

                const result = await response.json();

                if (result.success) {
                    isStreaming = true;
                    streamStartTime = Date.now();
                    
                    connectBtnText.textContent = '⏹️ Stop Stream';
                    connectBtn.disabled = false;
                    connectBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    connectBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    
                    updateConnectionStatus(true);
                    startVideoFeed();
                    startStatsUpdates();
                    
                    // Show stream-related sections
                    liveResults.classList.remove('hidden');
                    streamStats.classList.remove('hidden');
                    streamControls.classList.remove('hidden');
                    detectionCounter.classList.remove('hidden');
                    
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Stream start error:', error);
                alert(`Failed to start stream: ${error.message}`);
                connectBtn.disabled = false;
                connectBtnText.textContent = '🔴 Start Stream';
            }
        }

        async function stopStream() {
            try {
                const response = await fetch('/api/stop_live_stream', {
                    method: 'POST'
                });

                const result = await response.json();
                
                isStreaming = false;
                streamStartTime = null;
                
                connectBtnText.textContent = '🔴 Start Stream';
                connectBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                connectBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                updateConnectionStatus(false);
                stopVideoFeed();
                stopStatsUpdates();
                
                // Hide stream-related sections
                streamControls.classList.add('hidden');
                detectionCounter.classList.add('hidden');

            } catch (error) {
                console.error('Stream stop error:', error);
            }
        }

        function startVideoFeed() {
            // Start streaming from the Flask video feed endpoint
            videoStream.src = `/video_feed?t=${Date.now()}`;
            streamOverlay.textContent = '🔴 LIVE';
        }

        function stopVideoFeed() {
            // Stop video feed
            videoStream.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='450'%3E%3Crect width='100%25' height='100%25' fill='%23374151'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-size='24'%3ENo Stream Active%3C/text%3E%3C/svg%3E";
            streamOverlay.textContent = '🔴 OFFLINE';
        }

        function updateConnectionStatus(connected) {
            const statusEl = connectionStatus.firstElementChild;
            const dot = statusEl.querySelector('div');
            const text = statusEl.querySelector('span');
            
            if (connected) {
                statusEl.className = 'inline-flex items-center px-4 py-2 rounded-lg bg-green-100 text-green-700';
                dot.className = 'w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse';
                text.textContent = 'Connected - Live Stream Active';
            } else {
                statusEl.className = 'inline-flex items-center px-4 py-2 rounded-lg bg-gray-100 text-gray-600';
                dot.className = 'w-3 h-3 bg-gray-400 rounded-full mr-2';
                text.textContent = 'Disconnected';
            }
        }

        function startStatsUpdates() {
            statsInterval = setInterval(updateStats, 2000);
            uptimeInterval = setInterval(updateUptime, 1000);
        }

        function stopStatsUpdates() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
                uptimeInterval = null;
            }
        }

        async function updateStats() {
            if (!isStreaming) return;

            try {
                const response = await fetch('/api/live_stream_status');
                const data = await response.json();
                
                // Update stats (placeholder values for demo)
                document.getElementById('frameCount').textContent = Math.floor(Math.random() * 1000) + 500;
                document.getElementById('fpsCount').textContent = Math.floor(Math.random() * 10) + 25;
                document.getElementById('totalDetections').textContent = detectionHistory.length;
                
                // Simulate random detections for demo
                if (Math.random() < 0.1) { // 10% chance per update
                    simulateDetection();
                }
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function updateUptime() {
            if (!streamStartTime) return;
            
            const uptime = Math.floor((Date.now() - streamStartTime) / 1000);
            const minutes = Math.floor(uptime / 60);
            const seconds = uptime % 60;
            
            document.getElementById('streamUptime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function simulateDetection() {
            const animals = ['cow', 'goat', 'sheep', 'dog', 'cat', 'monkey', 'deer'];
            const priorities = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
            
            const detection = {
                animal: animals[Math.floor(Math.random() * animals.length)],
                confidence: 0.6 + Math.random() * 0.4,
                priority: priorities[Math.floor(Math.random() * priorities.length)],
                timestamp: new Date().toLocaleTimeString()
            };
            
            detectionHistory.unshift(detection);
            if (detectionHistory.length > 20) {
                detectionHistory = detectionHistory.slice(0, 20);
            }
            
            updateDetectionDisplay();
        }

        function updateDetectionDisplay() {
            // Update counter
            detectionCounter.textContent = `🐾 ${detectionHistory.length} animals detected`;
            
            // Update current detections (last 5)
            const currentDetections = detectionHistory.slice(0, 5);
            const container = document.getElementById('currentDetections');
            
            if (currentDetections.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">👀</div>
                        <p class="text-gray-600">Monitoring for animals...</p>
                    </div>
                `;
            } else {
                const animalEmojis = {
                    'elephant': '🐘', 'cow': '🐄', 'buffalo': '🐃', 'goat': '🐐',
                    'sheep': '🐑', 'pig': '🐷', 'dog': '🐕', 'cat': '🐱',
                    'monkey': '🐒', 'deer': '🦌', 'wild_boar': '🐗', 'nilgai': '🦌',
                    'peacock': '🦚', 'bird': '🐦', 'bear': '🐻', 'horse': '🐎'
                };
                
                const priorityColors = {
                    'CRITICAL': 'from-red-500 to-red-600',
                    'HIGH': 'from-orange-500 to-orange-600',
                    'MEDIUM': 'from-yellow-500 to-yellow-600',
                    'LOW': 'from-green-500 to-green-600'
                };
                
                container.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">🚨 Current Detections</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${currentDetections.map(detection => {
                            const emoji = animalEmojis[detection.animal] || '🐾';
                            const colorClass = priorityColors[detection.priority] || priorityColors['LOW'];
                            
                            return `
                                <div class="bg-gradient-to-r ${colorClass} rounded-lg p-4 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-2xl mb-1">${emoji}</div>
                                            <div class="font-medium">${detection.animal.toUpperCase()}</div>
                                            <div class="text-sm opacity-90">${detection.timestamp}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs opacity-75">${detection.priority}</div>
                                            <div class="text-sm">${Math.round(detection.confidence * 100)}%</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // Update history list
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = detectionHistory.map(detection => {
                const emoji = animalEmojis[detection.animal] || '🐾';
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${emoji}</span>
                            <div>
                                <div class="font-medium">${detection.animal.toUpperCase()}</div>
                                <div class="text-sm text-gray-600">${detection.timestamp}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">${Math.round(detection.confidence * 100)}%</div>
                            <div class="text-xs text-gray-500">${detection.priority}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function takeScreenshot() {
            // Create a canvas and draw the current video frame
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = videoStream.naturalWidth || 800;
            canvas.height = videoStream.naturalHeight || 450;
            
            ctx.drawImage(videoStream, 0, 0);
            
            // Download the screenshot
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `farm-detection-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function toggleFullscreen() {
            if (videoStream.requestFullscreen) {
                videoStream.requestFullscreen();
            }
        }

        // Handle video stream errors
        videoStream.addEventListener('error', function() {
            if (isStreaming) {
                streamOverlay.textContent = '❌ Stream Error';
                console.error('Video stream error');
            }
        });

        // Initialize detection display
        updateDetectionDisplay();
    </script>
</body>
</html>
